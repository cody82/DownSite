<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <script src="/js/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="js/ejs.js"></script>
    <style type="text/css">
html { height:100%; }
body { position:absolute; top:0; bottom:0; right:0; left:0; }
#images{ overflow:auto }
.bar {
    height: 18px;
    background: green;
}
</style>
    <title></title>
</head>
<body>
	<script type="text/javascript">
        var QueryString = function () {
            // This function is anonymous, is executed immediately and 
            // the return value is assigned to QueryString!
            var query_string = {};
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                // If first entry with this name
                if (typeof query_string[pair[0]] === "undefined") {
                    query_string[pair[0]] = pair[1];
                    // If second entry with this name
                } else if (typeof query_string[pair[0]] === "string") {
                    var arr = [query_string[pair[0]], pair[1]];
                    query_string[pair[0]] = arr;
                    // If third or later entry with this name
                } else {
                    query_string[pair[0]].push(pair[1]);
                }
            }
            return query_string;
        }();
        
        function get_article(name,callback) {
            $.ajax({
                type: "GET",
                url: "/article/title/"+name+"?format=json",
                processData: false,
                success: function (r) {
                    callback(r);
                }
            });
        }

        function get_article_by_id(id, callback) {
            $.ajax({
                type: "GET",
                url: "/article/id/" + id + "?format=json",
                processData: false,
                success: function (r) {
                    callback(r);
                }
            });
        }

        function save_article() {
            var id = $('#article_select').val();
            var cat = $('#article_category').val().split(",").map(function (x) { return { "ArticleId": id, "Name": x } });
            var article = { "Id": id, "Title": $('#article_title').val(), "Content": $('#article_content').val(), "Category": cat, "ShowInBlog": $('#blog_check')[0].checked, "ShowInMenu": $('#menu_check')[0].checked };
            $.ajax({
                type: "POST",
                url: "/article",// + article.Title,// + "?format=json",
                contentType: 'application/json',
                data: JSON.stringify(article),
                processData: false,
                success: function (r) {
                    $('#preview')[0].src = '/article/id/' + id;
                },
                error: function (r) {
                    alert("error");
                }
            });
        }

        function ejs_update(ejs_url, id, source_url, callback) {
            $.ajax({
                type: "GET",
                url: source_url,
                //processData: false,
                success: function (r) {
                    $.ajax({
                        type: "GET",
                        url: ejs_url,
                        //processData: false,
                        success: function (r2) {
                            new EJS({ text: r2 }).update(id, r);
                            if(callback)
                                callback(r);
                        }
                    });
                }
            });
        }

        function load_select(callback) {
            ejs_update('/articles-options.ejs', 'article_select', "/articles?format=json", function () { load_article(); if (callback) callback();});
        }

        function load_images() {
            ejs_update('/images.ejs', 'images', "/images?format=json");
        };

        function load_article() {
            var id = $('#article_select').val();
            if (id) {
                get_article(id, function (article) {
                    $('#article_title').val(article.Title);
                    $('#article_content').val(article.Content);
                    $('#menu_check')[0].checked = article.ShowInMenu;
                    $('#blog_check')[0].checked = article.ShowInBlog;
                    $('#article_category').val(function (row) { if (row.Category) { return row.Category.map(function (x) { return x.Name }).join(); } else { return ""; } }(article));
                    $('#preview')[0].src = '/article/id/' + id;
                });
            }
        };

        function article_add_text(text) {
            $('#article_content').val($('#article_content').val() + "\n" + text);
        }

        function create_article() {
            var article = { "Title": $('#article_title').val() };
            $.ajax({
                type: "PUT",
                url: "/article",// + article.Title,// + "?format=json",
                contentType: 'application/json',
                data: JSON.stringify(article),
                processData: false,
                success: function (r) {
                    load_select(function () {
                        var id = r.Id;
                        get_article_by_id(id, function (article) {
                            $('#article_title').val(article.Title);
                            $('#article_content').val(article.Content);
                            $('#preview')[0].src = '/article/id/' + id;
                            $('#article_select').val(article.Id);
                            $('#menu_check')[0].checked = article.ShowInMenu;
                            $('#blog_check')[0].checked = article.ShowInBlog;
                            load_article();
                        });
                    });
                },
                error: function (r) {
                    alert("error");
                }
            });
        };

        function delete_article() {
            var article_id = $('#article_select').val();
            $.ajax({
                type: "DELETE",
                url: "/article/id/" + article_id,
                processData: false,
                contentType: 'application/json',
                //data: article,
                complete: function (r) {
                    load_select();
                    $('#article_title').val("");
                    $('#article_content').val("");
                }
            });
        }


        function delete_image(id) {
            //var article_id = $('#article_select').val();
            $.ajax({
                type: "DELETE",
                url: "/image/" + id,
                processData: false,
                contentType: 'application/json',
                //data: article,
                complete: function (data,status,tmp) {
                    load_images();
                }
            });
        }

        $(document).ready(function () {
            load_images();
            load_select();
        });

    </script>
<script src="upload/js/vendor/jquery.ui.widget.js"></script>
<script src="upload/js/jquery.iframe-transport.js"></script>
<script src="upload/js/jquery.fileupload.js"></script>
<script>
    $(function () {
        $('#fileupload').fileupload({
            multipart: false,
            dataType: 'json',
            done: function (e, data) {
                //$('#upload_result').html('<img src="/image/' + data.result.Guid + '?thumb"></img>');
                //$('#input_image_guid').val(data.result.Guid);
                load_images();
                //$.each(data.result.files, function (index, file) {
                //    $('<p/>').text(file.name).appendTo(document.body);
                //});
            },
            progressall: function (e, data) {
                var progress = parseInt(data.loaded / data.total * 100, 10);
                $('#progress').html(progress + '%');
                $('#progressbar .bar').css(
                    'width',
                    progress + '%'
                );
            }
        });
    });
</script>


<div style="float:left;width:49%;height:100%">
    <select id="article_select" onchange="load_article()">
        <!--<option name=one value=one> one </option>
        <option name=two value=two> two </option>
        <option name=three value=three> three </option>-->
    </select>
<input id="article_title" type="text"></input><br />
category/tags:<input id="article_category" type="text"></input><br />
<input type="button" value="create" onclick="create_article()"/>
<input type="button" value="delete" onclick="delete_article()"/>
<p><input id="menu_check" type="checkbox"/>show in menu</p>
<p><input id="blog_check" type="checkbox"/>show in blog</p>
<textarea spellcheck="false" style="width:100%;height:40%" id="article_content" ></textarea>
<input type="button" value="save" onclick="save_article()"/>
    <div id="images" style="width:100%;height:400px;overflow:auto">

    </div>
    <div>
        <input id="fileupload" type="file" name="files[]" data-url="upload/" multiple/>
        <div id="progress"></div>
        <div id="progressbar">
        <div class="bar" style="width: 0%;"></div>
</div>
    </div>
<!--<div id="upload_result">
</div>-->


    </div>

<iframe id="preview" src="/" style="float:right;width:49%;height:100%">
</iframe>

</body>
</html>