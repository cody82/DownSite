<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <script src="/js/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="js/ejs.js"></script>
    <style type="text/css">
html { height:100%; }
body { position:absolute; top:0; bottom:0; right:0; left:0; }
#images{ overflow:auto }
</style>
    <title></title>
</head>
<body>
	<script type="text/javascript">
        var QueryString = function () {
            // This function is anonymous, is executed immediately and 
            // the return value is assigned to QueryString!
            var query_string = {};
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                // If first entry with this name
                if (typeof query_string[pair[0]] === "undefined") {
                    query_string[pair[0]] = pair[1];
                    // If second entry with this name
                } else if (typeof query_string[pair[0]] === "string") {
                    var arr = [query_string[pair[0]], pair[1]];
                    query_string[pair[0]] = arr;
                    // If third or later entry with this name
                } else {
                    query_string[pair[0]].push(pair[1]);
                }
            }
            return query_string;
        }();
        
        function get_article(name,callback) {
            $.ajax({
                type: "GET",
                url: "/article/"+name+"?format=json",
                processData: false,
                success: function (r) {
                    callback(r);
                }
            });
        }

        function save_article(name, callback) {
            var article = { "Title": $('#article_title').val(), "Content": $('#article_content').val() };
            $.ajax({
                type: "POST",
                url: "/article",// + article.Title,// + "?format=json",
                contentType: 'application/json',
                data: JSON.stringify(article),
                processData: false,
                success: function (r) {
                    $('#preview')[0].contentWindow.location.reload(true);
                },
                error: function (r) {
                    alert("error");
                }
            });
        }

        function load_images() {
            new EJS({ url: '/images.ejs' }).update('images', '/Images?format=json');
        };

        $(document).ready(function () {
            get_article(QueryString.article, function(article)
            {
                $('#article_title').val(article.Title);
                $('#article_content').val(article.Content);
            });
            load_images();
        });

    </script>
<script src="upload/js/vendor/jquery.ui.widget.js"></script>
<script src="upload/js/jquery.iframe-transport.js"></script>
<script src="upload/js/jquery.fileupload.js"></script>
<script>
    $(function () {
        $('#fileupload').fileupload({
            dataType: 'json',
            done: function (e, data) {
                //$('#upload_result').html('<img src="/Image/' + data.result.Guid + '?thumb"></img>');
                //$('#input_image_guid').val(data.result.Guid);
                load_images();
                //$.each(data.result.files, function (index, file) {
                //    $('<p/>').text(file.name).appendTo(document.body);
                //});
            }
        });
    });
</script>


<div style="float:left;width:49%;height:100%">
<input id="article_title" type="text"></input><br />
<textarea style="width:100%;height:40%" id="article_content" ></textarea>
<input type="button" value="save" onclick="save_article()"/>
    <div id="images" style="width:100%;height:400px;overflow:auto">

    </div>
        <input id="fileupload" type="file" name="files[]" data-url="upload/" multiple>
<!--<div id="upload_result">
</div>-->


    </div>

<iframe id="preview" src="/" style="float:right;width:49%;height:100%">
</iframe>

</body>
</html>