<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <script src="/js/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="js/ejs.js"></script>
    <script type="text/javascript" src="js/knockout-3.2.0.js"></script>
    <style type="text/css">
html { height:100%; }
body { position:absolute; top:0; bottom:0; right:0; left:0; }
#images{ overflow:auto }
.bar {
    height: 18px;
    background: green;
}


.row, .col { overflow: hidden; position: absolute; }
.row { left: 0; right: 0; }
.col { top: 0; bottom: 0; }
.scroll-x { overflow-x: auto; }
.scroll-y { overflow-y: auto; }

.header.row { height: 100px; top: 0;}
.body.row { top: 100px; bottom: 50px;}
.footer.row { height: 50px; bottom: 0; }

</style>
    <title></title>
</head>
<body>
	<script type="text/javascript">
        
        function get_article(name,callback) {
            $.ajax({
                type: "GET",
                url: "/article/title/"+name+"?format=json",
                processData: false,
                success: function (r) {
                    callback(r);
                }
            });
        }

        function get_article_by_id(id, callback) {
            $.ajax({
                type: "GET",
                url: "/article/id/" + id + "?format=json",
                processData: false,
                success: function (r) {
                    callback(r);
                }
            });
        }

        function save_article() {
            var id = $('#article_select').val();
            var cat = $('#article_category').val().split(",").map(function (x) { return { "ArticleId": id, "Name": x } });
            var article = { "Id": id, "Title": $('#article_title').val(), "Content": $('#article_content').val(), "Category": cat, "ShowInBlog": $('#blog_check')[0].checked, "ShowInMenu": $('#menu_check')[0].checked };
            $.ajax({
                type: "POST",
                url: "/article",// + article.Title,// + "?format=json",
                contentType: 'application/json',
                data: JSON.stringify(article),
                processData: false,
                success: function (r) {
                    $('#preview')[0].src = '/article/id/' + id;
                },
                error: function (r) {
                    alert("error");
                }
            });
        }

        function ejs_update(ejs_url, id, source_url, callback) {
            $.ajax({
                type: "GET",
                url: source_url,
                //processData: false,
                success: function (r) {
                    $.ajax({
                        type: "GET",
                        url: ejs_url,
                        //processData: false,
                        success: function (r2) {
                            new EJS({ text: r2 }).update(id, r);
                            if(callback)
                                callback(r);
                        }
                    });
                }
            });
        }

        function load_article() {
            var id = $('#article_select').val();
            if (id) {
                get_article(id, function (article) {
                    $('#article_title').val(article.Title);
                    $('#article_content').val(article.Content);
                    $('#menu_check')[0].checked = article.ShowInMenu;
                    $('#blog_check')[0].checked = article.ShowInBlog;
                    $('#article_category').val(function (row) { if (row.Category) { return row.Category.map(function (x) { return x.Name }).join(); } else { return ""; } }(article));
                    $('#preview')[0].src = '/article/id/' + id;
                });
            }
        };

        function article_add_text(text) {
            $('#article_content').val($('#article_content').val() + "\n" + text);
        }

        function create_article() {
            var article = { "Title": $('#article_title').val() };
            $.ajax({
                type: "PUT",
                url: "/article",// + article.Title,// + "?format=json",
                contentType: 'application/json',
                data: JSON.stringify(article),
                processData: false,
                success: function (r) {
                    load_select(function () {
                        var id = r.Id;
                        get_article_by_id(id, function (article) {
                            $('#article_title').val(article.Title);
                            $('#article_content').val(article.Content);
                            $('#preview')[0].src = '/article/id/' + id;
                            $('#article_select').val(article.Id);
                            $('#menu_check')[0].checked = article.ShowInMenu;
                            $('#blog_check')[0].checked = article.ShowInBlog;
                            load_article();
                        });
                    });
                },
                error: function (r) {
                    alert("error");
                }
            });
        };

        function delete_article() {
            var article_id = $('#article_select').val();
            $.ajax({
                type: "DELETE",
                url: "/article/id/" + article_id,
                processData: false,
                contentType: 'application/json',
                //data: article,
                complete: function (r) {
                    load_select();
                    $('#article_title').val("");
                    $('#article_content').val("");
                }
            });
        }

        function ImageViewModel(data) {
            var self = this;
            self.FileName = ko.observable(data.FileName);
            self.Id = ko.observable(data.Id);
            self.MimeType = ko.observable(data.MimeType);

            self.helper = function (obj) {
                if(obj.MimeType().substring(0,5) == 'video'){
                    return "video";
                } else {
                    return "";
                }
            }
            
            
            self.markdown = ko.computed(function () {
                return '![' +
                    this.helper(this)+
                    '](' +
                    '/image/' + this.Id() + '.' + this.MimeType().split('/')[1].replace('jpeg','jpg') +
                    ')';

            }, self);
            self.markdownLink = ko.computed(function () {
                return "javascript:article_add_text('" + self.markdown() + "')"

            }, self);
            self.previewLink = ko.computed(function () {
                return "/image/" + this.Id();
            }, self);
            self.deleteLink = ko.computed(function () {
                return "javascript:vm.imagelist.delete('" + this.Id() + "')";
            }, self);
            self.previewImage = ko.computed(function () {
                return "/image/" + this.Id() + "!thumb.jpg";
            }, self);
        }

        function ArticleViewModel(data) {
            var self = this;

            self.Id = ko.observable(data.Id);
            self.Title = ko.observable(data.Title);
            self.Content = ko.observable(data.Content);
            self.ShowInMenu = ko.observable(data.ShowInMenu);
            self.ShowInBlog = ko.observable(data.ShowInBlog);
        }

        function ArticleListViewModel() {
            var self = this;

            self.articles = ko.observableArray([]);

            self.load = function () {
                $.getJSON("/articles?format=json", function (allData) {
                    var articles = $.map(allData, function (item) { return new ArticleViewModel(item) });
                    self.articles(articles);
                });

            }

            self.load();
        }

        function ImageListViewModel() {
            var self = this;

            self.images = ko.observableArray([]);

            self.load = function () {
                $.getJSON("/images?format=json", function (allData) {
                    var images = $.map(allData, function(item) { return new ImageViewModel(item) });
                    self.images(images);
                });

            };

            self.delete = function (id) {
                $.ajax({
                    type: "DELETE",
                    url: "/image/" + id,
                    processData: false,
                    contentType: 'application/json',
                    //data: article,
                    complete: function (data, status, tmp) {
                        self.load();
                    }
                });
            }

            self.load();
        }

        function EditorViewModel() {
            var self = this;

            self.imagelist = new ImageListViewModel();
            self.articlelist = new ArticleListViewModel();

        }

        $(document).ready(function () {
            vm = new EditorViewModel();
            ko.applyBindings(vm);
        });

    </script>
<script src="upload/js/vendor/jquery.ui.widget.js"></script>
<script src="upload/js/jquery.iframe-transport.js"></script>
<script src="upload/js/jquery.fileupload.js"></script>
<script>
    $(function () {
        $('#fileupload').fileupload({
            multipart: false,
            dataType: 'json',
            done: function (e, data) {
                //$('#upload_result').html('<img src="/image/' + data.result.Guid + '?thumb"></img>');
                //$('#input_image_guid').val(data.result.Guid);
                load_images();
                //$.each(data.result.files, function (index, file) {
                //    $('<p/>').text(file.name).appendTo(document.body);
                //});
            },
            progressall: function (e, data) {
                var progress = parseInt(data.loaded / data.total * 100, 10);
                $('#progress').html(progress + '%');
                $('#progressbar .bar').css(
                    'width',
                    progress + '%'
                );
            }
        });
    });
</script>


<div style="float:left;width:49%;height:99%;position:absolute">
    <div class="header row">
        <select data-bind="foreach: articlelist.articles" id="article_select" onchange="load_article()">
            <option data-bind="text: Title, attr: {value: Id}"></option>
        </select>
        <input id="article_title" type="text"></input><br />
        tags:<input id="article_category" type="text"></input>
        <span><input id="menu_check" type="checkbox" />show in menu</span>
        <span><input id="blog_check" type="checkbox" />show in blog</span><br />
        <input type="button" value="create" onclick="create_article()" />
        <input type="button" value="delete" onclick="delete_article()" />
        <input type="button" value="save" onclick="save_article()" />
        <p>
        </p>
    </div>
    
    <div class="body row">
        <textarea spellcheck="false" style="width:99%;height:49%" id="article_content"></textarea>

        <div id="images" style="width:99%;height:49%;overflow:auto;">
            <table>
                <thead>
                    <tr>
                        <th>preview</th>
                        <th>markdown</th>
                        <th>filename</th>
                        <th>delete</th>
                    </tr>
                </thead>
                <tbody data-bind="foreach: imagelist.images">
                    <tr>
                        <td>
                            <a data-bind="attr: {href: previewLink}" target="_blank">
                                <img data-bind="attr: {src: previewImage}" />
                            </a>
                        </td>
                        <td>
                            <a data-bind="text: markdown, attr: {href: markdownLink}">
                            </a>
                        </td>
                        <td data-bind="text: FileName"/>
                        <td>
                            <a data-bind="attr: {href: deleteLink}">
                                delete
                            </a>
                        </td>
                    </tr>
                </tbody>
            </table>

        </div>
    </div>

        <div class="footer row">
            <input id="fileupload" type="file" name="files[]" data-url="upload/" multiple />
            <div id="progress"></div>
            <div id="progressbar">
                <div class="bar" style="width: 0%;"></div>
            </div>
        </div>
<!--<div id="upload_result">
</div>-->


    </div>

<iframe id="preview" src="/" style="float:right;width:49%;height:99%">
</iframe>

</body>
</html>